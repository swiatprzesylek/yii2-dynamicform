(function($){var pluginName="yiiDynamicForm",regexID=/^(.+?)([-\d-]{1,})(.+)$/i,regexName=/(^.+?)([\[\d{1,}\]]{1,})(\[.+\]$)/i;$.fn.yiiDynamicForm=function(a){return methods[a]?methods[a].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof a&&a?($.error("Method "+a+" does not exist on jQuery.yiiDynamicForm"),!1):methods.init.apply(this,arguments)};var events={beforeInsert:"beforeInsert",afterInsert:"afterInsert",beforeDelete:"beforeDelete",afterDelete:"afterDelete",limitReached:"limitReached"},methods={init:function(a){return this.each(function(){a.template=_parseTemplate(a)})},addItem:function(a,b,c){_addItem(a,b,c)},deleteItem:function(a,b,c){_deleteItem(a,b,c)},updateContainer:function(){var widgetOptions=eval($(this).attr("data-dynamicform"));_updateAttributes(widgetOptions),_restoreSpecialJs(widgetOptions),_fixFormValidaton(widgetOptions)}},_parseTemplate=function(widgetOptions){var $template=$(widgetOptions.template);$template.find("div[data-dynamicform]").each(function(){var widgetOptions=eval($(this).attr("data-dynamicform"));if(1<$(widgetOptions.widgetItem).length){var item=$(this).find(widgetOptions.widgetItem).first()[0].outerHTML;$(this).find(widgetOptions.widgetBody).html(item)}}),$template.find("input, textarea, select").each(function(){if($(this).is(":checkbox")||$(this).is(":radio")){var a=$(this).is(":checkbox")?"checkbox":"radio",b=$(this).attr("name"),c=$template.find("input[type=\"hidden\"][name=\""+b+"\"]").first(),d=$template.find("input[type=\""+a+"\"][name=\""+b+"\"]").length;c&&1===d&&($(this).val(1),c.val(0)),$(this).prop("checked",!1)}else $(this).is("select")?$(this).find("option:selected").removeAttr("selected"):$(this).val("")});var yiiActiveFormData=$("#"+widgetOptions.formId).yiiActiveForm("data");return $template.find("."+yiiActiveFormData.settings.errorCssClass).removeClass(yiiActiveFormData.settings.errorCssClass),$template.find("."+yiiActiveFormData.settings.successCssClass).removeClass(yiiActiveFormData.settings.successCssClass),$template},_getWidgetOptionsRoot=function(widgetOptions){return eval($(widgetOptions.widgetBody).parents("div[data-dynamicform]").last().attr("data-dynamicform"))},_getLevel=function(a){var b=a.parents("div[data-dynamicform]").length;return b=0>b?0:b,b},_count=function(a,b){return a.closest("."+b.widgetContainer).find(b.widgetItem).length},_createIdentifiers=function(a){return Array(a+2).join("0").split("")},_addItem=function(a,b,c){var d=_count(c,a);d<a.limit?($toclone=$(a.template),$newclone=$toclone.clone(!1,!1),"top"===a.insertPosition?c.closest("."+a.widgetContainer).find(a.widgetBody).prepend($newclone):c.closest("."+a.widgetContainer).find(a.widgetBody).append($newclone),_updateAttributes(a),_restoreSpecialJs(a),_fixFormValidaton(a),c.closest("."+a.widgetContainer).triggerHandler(events.afterInsert,$newclone)):c.closest("."+a.widgetContainer).triggerHandler(events.limitReached,a.limit)},_removeValidations=function($elem,widgetOptions,count){if(1<count){$elem.find("div[data-dynamicform]").each(function(){for(var aux,currentWidgetOptions=eval($(this).attr("data-dynamicform")),level=_getLevel($(this)),identifiers=_createIdentifiers(level),numItems=$(this).find(currentWidgetOptions.widgetItem).length,i=1;i<=numItems-1;i++)aux=identifiers,aux[level]=i,currentWidgetOptions.fields.forEach(function(a){var b=a.id.replace("{}",aux.join("-"));"undefined"!==$("#"+currentWidgetOptions.formId).yiiActiveForm("find",b)&&$("#"+currentWidgetOptions.formId).yiiActiveForm("remove",b)})});var level=_getLevel($elem.closest("."+widgetOptions.widgetContainer)),widgetOptionsRoot=_getWidgetOptionsRoot(widgetOptions),identifiers=_createIdentifiers(level);identifiers[0]=$(widgetOptionsRoot.widgetItem).length-1,identifiers[level]=count-1,widgetOptions.fields.forEach(function(a){var b=a.id.replace("{}",identifiers.join("-"));"undefined"!==$("#"+widgetOptions.formId).yiiActiveForm("find",b)&&$("#"+widgetOptions.formId).yiiActiveForm("remove",b)})}},_deleteItem=function(a,b,c){var d=_count(c,a);if(d>a.min){$todelete=c.closest(a.widgetItem);var e=$("."+a.widgetContainer).triggerHandler(events.beforeDelete,$todelete);!1!==e&&(_removeValidations($todelete,a,d),$todelete.remove(),_updateAttributes(a),_restoreSpecialJs(a),_fixFormValidaton(a),$("."+a.widgetContainer).triggerHandler(events.afterDelete))}},_updateAttrID=function($elem,index){var widgetOptions=eval($elem.closest("div[data-dynamicform]").attr("data-dynamicform")),id=$elem.attr("id"),newID=id;if(void 0!==id){var matches=id.match(regexID);if(matches&&4===matches.length){matches[2]=matches[2].substring(1,matches[2].length-1);var identifiers=matches[2].split("-");if(identifiers[0]=index,1<identifiers.length){var widgetsOptions=[];$elem.parents("div[data-dynamicform]").each(function(i){widgetsOptions[i]=eval($(this).attr("data-dynamicform"))}),widgetsOptions=widgetsOptions.reverse();for(var i=identifiers.length-1;1<=i;i--)"undefined"!=typeof widgetsOptions[i]&&(identifiers[i]=$elem.closest(widgetsOptions[i].widgetItem).index())}newID=matches[1]+"-"+identifiers.join("-")+"-"+matches[3],$elem.attr("id",newID)}else newID=id+index,$elem.attr("id",newID)}return id!==newID&&($elem.closest(widgetOptions.widgetItem).find(".field-"+id).each(function(){$(this).removeClass("field-"+id).addClass("field-"+newID)}),$elem.closest(widgetOptions.widgetItem).find("label[for='"+id+"']").attr("for",newID)),newID},_updateAttrName=function($elem,index){var name=$elem.attr("name");if(name!==void 0){var matches=name.match(regexName);if(matches&&4===matches.length){matches[2]=matches[2].replace(/\]\[/g,"-").replace(/\]|\[/g,"");var identifiers=matches[2].split("-");if(identifiers[0]=index,1<identifiers.length){var widgetsOptions=[];$elem.parents("div[data-dynamicform]").each(function(i){widgetsOptions[i]=eval($(this).attr("data-dynamicform"))}),widgetsOptions=widgetsOptions.reverse();for(var i=identifiers.length-1;1<=i;i--)"undefined"!=typeof widgetsOptions[i]&&(identifiers[i]=$elem.closest(widgetsOptions[i].widgetItem).index())}name=matches[1]+"["+identifiers.join("][")+"]"+matches[3],$elem.attr("name",name)}}return name},_updateAttributes=function(a){var b=_getWidgetOptionsRoot(a);$(b.widgetItem).each(function(a){$(this);$(this).find("*").each(function(){_updateAttrID($(this),a),_updateAttrName($(this),a)})})},_fixFormValidatonInput=function(a,b,c,d){b!==void 0&&(b=$.extend(!0,{},b),b.id=c,b.container=".field-"+c,b.input="#"+c,b.name=d,b.value=$("#"+c).val(),b.status=0,"undefined"!==$("#"+a.formId).yiiActiveForm("find",c)&&$("#"+a.formId).yiiActiveForm("remove",c),$("#"+a.formId).yiiActiveForm("add",b))},_fixFormValidaton=function(widgetOptions){var widgetOptionsRoot=_getWidgetOptionsRoot(widgetOptions);$(widgetOptionsRoot.widgetBody).find("input, textarea, select").each(function(){var id=$(this).attr("id"),name=$(this).attr("name");if(id!==void 0&&name!==void 0){currentWidgetOptions=eval($(this).closest("div[data-dynamicform]").attr("data-dynamicform"));var matches=id.match(regexID);if(matches&&4===matches.length){matches[2]=matches[2].substring(1,matches[2].length-1);var level=_getLevel($(this)),identifiers=_createIdentifiers(level-1),baseID=matches[1]+"-"+identifiers.join("-")+"-"+matches[3],attribute=$("#"+currentWidgetOptions.formId).yiiActiveForm("find",baseID);_fixFormValidatonInput(currentWidgetOptions,attribute,id,name)}}})},_restoreKrajeeDepdrop=function($elem){var configDepdrop=$.extend(!0,{},eval($elem.attr("data-krajee-depdrop"))),inputID=$elem.attr("id"),matchID=inputID.match(regexID);if(matchID&&4===matchID.length)for(index=0;index<configDepdrop.depends.length;++index){var match=configDepdrop.depends[index].match(regexID);match&&4===match.length&&(configDepdrop.depends[index]=match[1]+matchID[2]+match[3])}$elem.depdrop(configDepdrop)},_restoreSpecialJs=function(widgetOptions){var widgetOptionsRoot=_getWidgetOptionsRoot(widgetOptions),$hasInputmask=$(widgetOptionsRoot.widgetItem).find("[data-plugin-inputmask]");0<$hasInputmask.length&&$hasInputmask.each(function(){$(this).inputmask("remove"),$(this).inputmask(eval($(this).attr("data-plugin-inputmask")))});var $hasDatepicker=$(widgetOptionsRoot.widgetItem).find("[data-krajee-kvdatepicker]");0<$hasDatepicker.length&&$hasDatepicker.each(function(){$(this).parent().removeData().kvDatepicker("destroy"),$(this).parent().kvDatepicker(eval($(this).attr("data-krajee-kvdatepicker")))});var $hasTimepicker=$(widgetOptionsRoot.widgetItem).find("[data-krajee-timepicker]");0<$hasTimepicker.length&&$hasTimepicker.each(function(){$(this).removeData().off(),$(this).parent().find(".bootstrap-timepicker-widget").remove(),$(this).unbind(),$(this).timepicker(eval($(this).attr("data-krajee-timepicker")))});var $hasMaskmoney=$(widgetOptionsRoot.widgetItem).find("[data-krajee-maskMoney]");0<$hasMaskmoney.length&&$hasMaskmoney.each(function(){$(this).parent().find("input").removeData().off();var id="#"+$(this).attr("id"),displayID=id+"-disp";$(displayID).maskMoney("destroy"),$(displayID).maskMoney(eval($(this).attr("data-krajee-maskMoney"))),$(displayID).maskMoney("mask",parseFloat($(id).val())),$(displayID).on("change",function(){var a=$(displayID).maskMoney("unmasked")[0];$(id).val(a),$(id).trigger("change")})});var $hasFileinput=$(widgetOptionsRoot.widgetItem).find("[data-krajee-fileinput]");0<$hasFileinput.length&&$hasFileinput.each(function(){$(this).fileinput(eval($(this).attr("data-krajee-fileinput")))});var $hasTouchSpin=$(widgetOptionsRoot.widgetItem).find("[data-krajee-TouchSpin]");0<$hasTouchSpin.length&&$hasTouchSpin.each(function(){$(this).TouchSpin("destroy"),$(this).TouchSpin(eval($(this).attr("data-krajee-TouchSpin")))});var $hasSpectrum=$(widgetOptionsRoot.widgetItem).find("[data-krajee-spectrum]");0<$hasSpectrum.length&&$hasSpectrum.each(function(){var id="#"+$(this).attr("id"),sourceID=id+"-source";$(sourceID).spectrum("destroy"),$(sourceID).unbind(),$(id).unbind();var configSpectrum=eval($(this).attr("data-krajee-spectrum"));configSpectrum.change=function(a){jQuery(id).val(a.toString())},$(sourceID).attr("name",$(sourceID).attr("id")),$(sourceID).spectrum(configSpectrum),$(sourceID).spectrum("set",jQuery(id).val()),$(id).on("change",function(){$(sourceID).spectrum("set",jQuery(id).val())})});var $hasDepdrop=$(widgetOptionsRoot.widgetItem).find("[data-krajee-depdrop]");0<$hasDepdrop.length&&$hasDepdrop.each(function(){$(this).data("select2")===void 0&&($(this).removeData().off(),$(this).unbind(),_restoreKrajeeDepdrop($(this)))});var $hasSelect2=$(widgetOptionsRoot.widgetItem).find("[data-krajee-select2]");0<$hasSelect2.length&&$hasSelect2.each(function(){var id=$(this).attr("id"),configSelect2=eval($(this).attr("data-krajee-select2"));$(this).data("select2")&&$(this).select2("destroy");var configDepdrop=$(this).data("depdrop");configDepdrop&&(configDepdrop=$.extend(!0,{},configDepdrop),$(this).removeData().off(),$(this).unbind(),_restoreKrajeeDepdrop($(this))),$.when($("#"+id).select2(configSelect2)).done(initS2Loading(id,".select2-container--krajee"));var kvClose="kv_close_"+id.replace(/\-/g,"_");if($("#"+id).on("select2:opening",function(a){initS2Loading(id,kvClose,a)}),$("#"+id).on("select2:unselect",function(){window[kvClose]=!0}),configDepdrop){var loadingText=configDepdrop.loadingText?configDepdrop.loadingText:"Loading ...";initDepdropS2(id,loadingText)}});var $hasSwitchinput=$(widgetOptionsRoot.widgetItem).find("[data-krajee-bootstrapswitch]");0<$hasSwitchinput.length&&$hasSwitchinput.each(function(){$(this).bootstrapSwitch(eval($(this).attr("data-krajee-bootstrapswitch")))});var $hasKvSortable=$(widgetOptionsRoot.widgetItem).find("[data-krajee-kvhtml5sortable]");0<$hasKvSortable.length&&$hasKvSortable.each(function(){$(this).kvHtml5Sortable(eval($(this).attr("data-krajee-kvhtml5sortable")))})}})(window.jQuery);